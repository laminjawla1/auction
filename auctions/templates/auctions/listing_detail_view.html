{% extends "auctions/layout.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load humanize %}
{% block body %}

<article class="media content-section">
    <div class="row">
        {% if user == listing.listed_by and listing.active %}
            <a href="{% url 'update_listing' listing.pk %}" class="btn btn-success btn-sm">Edit</a>
            &nbsp;
            <a href="{% url 'close_listing' listing.pk %}" class="btn btn-danger btn-sm text-center">Close</a>
        {% endif %}
        <div class="col-md-12">
            <div class="article-metadata">
                <div class="row">
                    <div class="col-md-4 text-center">
                        Listed By: 
                        <a class="mr-2" href="#">{{ listing.listed_by }}</a>
                    </div>
                    <div class="col-md-4 text-center">
                        Category: 
                        <a class="mr-2" href="{% url 'listing_by_category' listing.category.name %}">{{ listing.category }}</a>
                    </div>
                    <div class="col-md-4 text-center">
                        <small class="text-muted">Date: {{ listing.date_created|date:"F d, Y" }}</small>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-4 text-center">
                    <h2 class="article-title"> {{ listing.title|title }}</h2>
                </div>
                <div class="col-md-4 text-center">
                    <h2 class="article-title"> ${{ listing.price|floatformat:2|intcomma }}</h2>
                </div>
                <div class="col-md-4 text-center">
                    <h2 class="article-title">
                        <form action="{% url 'like_listing' listing.id %}" method="POST">
                            {% csrf_token %}
                            {% if liked %}
                              <button type="submit", name="post_id", value="{{ post.id }}", class="btn btn-danger btn-sm">Unlike</button> - {{ total_likes }} Likes
                            {% else %}
                              <button type="submit", name="post_id", value="{{ post.id }}", class="btn btn-primary btn-sm">Like</button> - {{ total_likes }} Likes
                            {% endif %}
                        </form>
                    </h2>
                </div>
            </div>
            <hr>
        </div>
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-6">
                    <img class="article-img" src="{{ listing.image.url }}" alt="image">
                </div>
                <div class="col-md-6">
                    <p class="article-content">{{ listing.description }}</p>
                </div>
            </div>
        </div>
        {% if listing.active %}
        <div class="col-md-12">
            <hr>
            <div class="row">
                <div class="col-md-6 text-center">
                    <h3>Comments ({{ comments.count}})</h3>
                    <a class="btn btn-primary btn-block mb-1" data-bs-toggle="modal" data-bs-target="#commentModal" data-bs-whatever="@mdo" href="#">Add Comment</a>
                    {% for comment in comments %}
                        <article class="media content-section border border-info">
                            <img class="rounded-circle" src="{{ comment.commentator.image.url }}" alt="image" width="50" height="50">
                            <div class="media-body">
                                <div class="article-metadata">
                                <small class="mr-2">{{ comment.commentator.username }}</small>
                                <small class="text-muted">{{ comment.date_commented|date:"F d, Y" }}</small>
                                {% if user == comment.commentator %}
                                    <a href="{% url 'update_comment' comment.id %}">Edit</a>
                                {% endif %}
                                </div>
                                <p class="article-content">{{ comment.message|safe }}</p>
                            </div>
                        </article>
                    {% endfor %}
                </div>
                <div class="col-md-6 text-center">
                    <h3>Bids ({{bids.count}})</h3>
                    <a class="btn btn-danger btn-block mb-1" data-bs-toggle="modal" data-bs-target="#biddingModal" data-bs-whatever="@mdo" href="#">Place Bid</a>
                    {% for bid in bids %}
                        <article class="media content-section border border-info">
                            <img class="rounded-circle" src="{{ bid.bidder.image.url }}" alt="image" width="50" height="50">
                            <div class="media-body">
                                <div class="article-metadata">
                                <small class="mr-2">{{ bid.bidder.username }}</small>
                                <small class="text-muted">{{ bid.date_bid|date:"F d, Y" }}</small>
                                </div>
                                <p class="article-content">${{ bid.price|floatformat:2|intcomma }}</p>
                            </div>
                        </article>
                        {% endfor %}
                        <p class="article-content">Current Bidder: {{ listing.current_bidder }}</p>
                </div>
            </div>
        </div>
        {% else %}
        <h1 class="text-center">Won by {{listing.current_bidder}}</h1>
        {% endif %}
    </div>
</article>
<div class="row">
    <div class="col-md-12">
        {% if not in_watch_list %}
            <a href="{% url 'add_to_watch_list' listing.id %}" class="btn btn-success btn-block">Add to WatchList</a>
        {% endif %}
    </div>
</div>
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="commentModal" >Commenting...</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>
        </div>
        <div class="modal-body content-section">
          <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <fieldset class="form-group">
                {{ comment_form|crispy }}
            </fieldset>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Comment</button>
            </div>
        </form>
        </div>
      </div>
    </div>
  </div>

<div class="modal fade" id="biddingModal" tabindex="-1" aria-labelledby="biddingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="biddingModal" >Bidding...</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>
        </div>
        <div class="modal-body content-section">
          <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <fieldset class="form-group">
                {{ bidding_form|crispy }}
            </fieldset>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Bid</button>
            </div>
        </form>
        </div>
      </div>
    </div>
  </div>

{% endblock %}